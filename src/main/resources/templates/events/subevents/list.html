<!DOCTYPE html>
<html xmlns:th="https://www.thymeleaf.org">

<head th:insert="~{fragments/header}"></head>

<body class="bg-gray-100">
  <!-- Header -->
  <div th:insert="~{fragments/top :: top}"></div>

  <!-- Content -->
  <main th:fragment="main" class="main container mx-auto p-4 pt-10 pb-10">
    <nav class="mb-6">
      <ol class="flex text-sm text-gray-500">
        <li class="flex items-center">
          <a href="/events" class="font-['Poppins'] hover:text-primary">Eventos</a>
          <div class="w-4 h-4 flex items-center justify-center mx-1">
            <i class="ri-arrow-right-s-line"></i>
          </div>
        </li>
        <li class="flex items-center">
          <a href="#" th:text="${event.event.title}" class="hover:text-primary"></a>
          <div class="w-4 h-4 flex items-center justify-center mx-1">
            <i class="ri-arrow-right-s-line"></i>
          </div>
        </li>
        <li class="text-primary font-medium">Álbuns</li>
      </ol>
    </nav>
    <div class="mb-8">
      <div class="flex items-center justify-between">
        <div>
          <h1 th:text="${event.event.title}" class="text-3xl md:text-4xl font-bold text-gray-900 mb-2"></h1>
          <p class="text-gray-600">Navegue entre os álbuns do evento <span th:text="${event.event.title}"
              class="font-bold" /></p>
        </div>
        <button id="subscribeBtn" th:if="${authentication != null}"
          class="flex items-center justify-center w-12 h-12 text-gray-500 hover:text-primary transition-colors"
          title="Subscribe to notifications">
          <i class="ri-notification-3-line ri-2x" title="Receba notificações quando um novo álbum for adicionado"></i>
        </button>
      </div>
    </div>
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
      <!-- Album 1 -->
      <a th:each="subEvents : ${event.subEvents}"
        th:href="@{/events/{eventUrl}/albums/{subEventName}(eventUrl=${event.event.eventUrl}, subEventName=${subEvents.name})}"
        class="folder-card bg-white rounded-lg shadow-sm overflow-hidden transition-all duration-300">
        <div class="relative aspect-[4/3] overflow-hidden">
          <img th:src="${subEvents.coverUrl != null ? subEvents.coverUrl: '/album-image.jpg'}"
            class="w-full h-full object-cover object-top" />
          <!--					<div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/60 to-transparent p-4">-->
          <!--						<span class="inline-block px-2 py-1 bg-white/90 rounded-full text-xs font-medium">May 29, 2025</span>-->
          <!--					</div>-->
        </div>
        <div class="p-4">
          <h3 th:text="${subEvents.name}" class="text-lg font-semibold text-gray-900 mb-1"></h3>
          <!--					<div class="flex items-center text-sm text-gray-500">-->
          <!--						<div class="w-4 h-4 flex items-center justify-center mr-1">-->
          <!--							<i class="ri-image-line"></i>-->
          <!--						</div>-->
          <!--						<span>42 photos</span>-->
          <!--					</div>-->
        </div>
      </a>
    </div>
    <div th:if="${authentication != null}">
      <button type="button" onclick="showLocalNotification()">NOTIFY</button>
    </div>
    <script>
      function showLocalNotification() {
        Notification.requestPermission().then(permission => {
          if (permission === "granted") {
            new Notification("Hello!", {body: "This is a local notification."});
          }
        });
      }
    </script>
  </main>
  <script th:if="${authentication != null}" id="browserNotificationScript">
    document.addEventListener('DOMContentLoaded', () => {
      const subscribeBtn = document.getElementById('subscribeBtn');
      let isSubscribed = false;

      const updateSubscriptionIcon = () => {
        const icon = subscribeBtn.querySelector('i');
        icon.className = isSubscribed ? 'ri-notification-fill ri-2x' : 'ri-notification-line ri-2x';
        subscribeBtn.title = isSubscribed ? 'Pare de receber notificações' : 'Receba notificações quando um novo álbum for adicionado';
      };

      const showModal = () => {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        modal.innerHTML = `
<div class="bg-white p-6 rounded-lg shadow-xl max-w-sm mx-4">
  <h3 class="text-xl font-semibold text-gray-900 mb-4">Habilite Notificações</h3>
  <p class="text-gray-600 mb-6">Para receber notificações sobre novos álbuns, por favor habilite as notificações nas configurações do seu navegador.</p>
  <button class="w-full px-4 py-2 bg-primary text-white !rounded-button">Close</button>
</div>
        `;
        document.body.appendChild(modal);
        modal.querySelector('button').onclick = () => modal.remove();
      };

      const requestNotificationPermission = () => {
        return new Promise((resolve, reject) => {
          if (!('Notification' in window)) {
            reject(new Error('Notificações não são suportadas por este navegador.'));
          } else {
            Notification.requestPermission().then(resolve).catch(reject);
          }
        });
      };

      const handlePermission = () => {
        requestNotificationPermission()
          .then(permission => {
            if (permission === 'granted') {
              isSubscribed = true;
              updateSubscriptionIcon();
              new Notification('Notificações Ativadas', {
                body: 'Você receberá notificações sobre novos álbuns.',
                icon: '/favicon.ico'
              });
            } else {
              showModal();
            }
          })
          .catch(() => {
            showModal();
          });
      };

      subscribeBtn.addEventListener('click', handlePermission);
    });
  </script>
  <!-- footer -->
  <div th:replace="~{fragments/footer :: footer}"></div>
</body>

</html>
